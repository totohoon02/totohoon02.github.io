# 📌 DB Replication

데이터베이스의 **고가용성(HA)** 및 **데이터 안정성**을 확보하기 위한 핵심 기술 중 하나로, 대규모 애플리케이션 환경에서 **데이터 일관성**과 **신뢰성**을 유지하는 데 중요한 역할을 합니다.

---

## ✅ 개념 정리

- **Replication(복제)**: 원본(Source) 서버에서 발생한 데이터 변경 사항을 복제(Replica) 서버로 **동기화**하여 **데이터 일관성**을 유지하는 기술
- **목표**:
  - 장애 발생 시 빠른 복구
  - 읽기 부하 분산(Read Replication)
  - 백업/분석 서버 분리

---

## 🔧 Binary Log 저장 방식

MySQL은 Source 서버의 **데이터 변경 이력을 기록하는 Binary Log**를 기반으로 복제를 수행하며, 로그 저장 방식은 다음 세 가지로 구성됩니다:

### 1. Row 기반

- **특징**: 변경된 **행(row) 단위의 데이터**를 기록
- **장점**:
  - 데이터 일관성 보장 ↑ (복제 정확도 매우 높음)
- **단점**:
  - 변경된 행 전체를 저장 → **로그 크기 증가**
- **예시**:

  ```sql
  UPDATE user SET name = 'Kim' WHERE id = 1;
  ```

  → 로그에는 `id=1` 행의 변경 **전후 상태**가 저장됨

---

### 2. Statement 기반

- **특징**: 실행된 **SQL 문장 자체**를 기록
- **장점**:
  - 로그 크기 작음 (공간 효율 ↑)
- **단점**:
  - 비결정적 쿼리 (예: `NOW()`, `UUID()`) 사용 시 **복제 불일치** 발생 가능성
    - 실행 시 마다 결과가 달라지는 쿼리
- **예시**:

  ```sql
  UPDATE user SET created_at = NOW() WHERE id = 1;
  ```

  → 실행 시점에 따라 Source/Replica 결과가 달라질 수 있음

---

### 3. Mixed 기반

- **특징**: 상황에 따라 Row + Statement 혼합
- **장점**:
  - **공간 효율 + 일관성** 동시 확보
- **단점**:

  - 구현 복잡도 ↑

- **동작 방식**:
  - 결정적 쿼리: Statement 방식 사용
  - 비결정적 쿼리: Row 방식 자동 전환
    - 두 방식을 혼합해 상황에 따라 사용

---

## 🔁 복제 과정

```plaintext
[1] Source 서버
   - 데이터 변경 쿼리 실행
   - Binary log에 변경 기록 (Row/Statement/Mixed 방식)

[2] Replica 서버
   - IO Thread: Source로부터 Binary log 받아서 → Relay log 저장
   - SQL Thread: Relay log 기반으로 DB 반영
```

- **Relay Log**: Replica 서버에서 Binary log를 임시로 저장하는 파일
- **복제 지연 시간**: 보통 **100ms 이내**로 실시간에 가까운 동기화 가능

---

## ✅ 요약

| 구분      | Row 방식         | Statement 방식     | Mixed 방식           |
| --------- | ---------------- | ------------------ | -------------------- |
| 기록 방식 | 행(row) 변경값   | SQL 문장           | 혼합 사용            |
| 장점      | 데이터 정확도 ↑  | 공간 효율 ↑        | 정확도 + 공간 효율   |
| 단점      | 로그 크기 ↑      | 데이터 불일치 위험 | 구현 복잡도 ↑        |
| 사용 추천 | 중요 데이터 복제 | 단순 쿼리 중심     | 대부분 환경에서 권장 |

---

## ✅ 실무 활용 팁

- **읽기 부하 분산**: 복제 서버를 Read-Only API 서버로 활용
- **백업 서버**: 백업 작업은 Replica에서 수행하여 성능 저하 방지
- **모니터링 필수**: 복제 지연(Lag)을 지속적으로 체크

---
